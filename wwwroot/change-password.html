<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªïi m·∫≠t kh·∫©u - HUTECH StudyMate</title>
    <link rel="icon" type="image/x-icon" href="img/hutech.ico">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .auth-container {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        .auth-container img {
            height: 60px;
            margin-bottom: 1rem;
        }

        .auth-container h2 {
            color: #e53935;
            margin-bottom: 1rem;
        }

        .welcome-message {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            text-align: left;
            font-size: 0.95rem;
            color: #856404;
        }

        .welcome-message strong {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
            font-weight: 500;
        }

        .password-input-wrapper {
            position: relative;
        }

        .password-input-wrapper input {
            width: 100%;
            padding: 0.8rem;
            padding-right: 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .password-input-wrapper input:focus {
            border-color: #e53935;
            outline: none;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            color: #e53935;
        }

        .btn-submit {
            width: 100%;
            padding: 0.8rem;
            background: #e53935;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 1rem;
        }

        .btn-submit:hover {
            background: #d32f2f;
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-message,
        .success-message {
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
            font-size: 0.9rem;
        }

        .error-message {
            color: #d32f2f;
            background: #ffebee;
            border-left: 4px solid #d32f2f;
        }

        .success-message {
            color: #2e7d32;
            background: #e8f5e9;
            border-left: 4px solid #2e7d32;
        }

        .password-requirements {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 6px;
            text-align: left;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .validation-item.valid {
            color: #2e7d32;
        }

        .validation-item.invalid {
            color: #d32f2f;
        }

        .validation-icon {
            font-size: 0.9rem;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="auth-container">
        <img src="https://hutech.edu.vn/images/logo.png" alt="HUTECH Logo">
        <h2>ƒê·ªïi m·∫≠t kh·∫©u b·∫Øt bu·ªôc</h2>

        <div class="welcome-message">
            <strong>Y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u</strong>
            B·∫°n ƒëang s·ª≠ d·ª•ng m·∫≠t kh·∫©u t·ª± ƒë·ªông. Vui l√≤ng ƒë·ªïi sang m·∫≠t kh·∫©u m·ªõi ƒë·ªÉ b·∫£o ƒë·∫£m an to√†n t√†i kho·∫£n.
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <form id="changePasswordForm">
            <div class="form-group">
                <label for="oldPassword">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                <div class="password-input-wrapper">
                    <input type="password" id="oldPassword" name="oldPassword" required autocomplete="current-password">
                    <button type="button" class="password-toggle" onclick="togglePassword('oldPassword')">üëÅÔ∏è</button>
                </div>
            </div>
            <div class="form-group">
                <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                <div class="password-input-wrapper">
                    <input type="password" id="newPassword" name="newPassword" required autocomplete="new-password">
                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">üëÅÔ∏è</button>
                </div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                <div class="password-input-wrapper">
                    <input type="password" id="confirmPassword" name="confirmPassword" required
                        autocomplete="new-password">
                    <button type="button" class="password-toggle"
                        onclick="togglePassword('confirmPassword')">üëÅÔ∏è</button>
                </div>
            </div>

            <div class="password-requirements">
                <strong>Y√™u c·∫ßu m·∫≠t kh·∫©u m·ªõi:</strong>
                <div id="passwordValidation" style="margin-top: 0.5rem;">
                    <div class="validation-item invalid" id="lengthCheck">
                        <span class="validation-icon">‚úó</span>
                        <span>H∆°n 6 k√Ω t·ª± (t·ªëi thi·ªÉu 7)</span>
                    </div>
                    <div class="validation-item invalid" id="uppercaseCheck">
                        <span class="validation-icon">‚úó</span>
                        <span>C√≥ ch·ªØ hoa (A-Z)</span>
                    </div>
                    <div class="validation-item invalid" id="lowercaseCheck">
                        <span class="validation-icon">‚úó</span>
                        <span>C√≥ ch·ªØ th∆∞·ªùng (a-z)</span>
                    </div>
                    <div class="validation-item invalid" id="numberCheck">
                        <span class="validation-icon">‚úó</span>
                        <span>C√≥ s·ªë (0-9)</span>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-submit">ƒê·ªïi m·∫≠t kh·∫©u</button>
        </form>
    </div>

    <script>
        // Password visibility toggle
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.parentElement.querySelector('.password-toggle');

            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'üôà';
            } else {
                field.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // Password validation
        function validatePassword(password) {
            const checks = {
                length: password.length > 6,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password)
            };

            // Update UI
            updateValidationUI('lengthCheck', checks.length);
            updateValidationUI('uppercaseCheck', checks.uppercase);
            updateValidationUI('lowercaseCheck', checks.lowercase);
            updateValidationUI('numberCheck', checks.number);

            return checks.length && checks.uppercase && checks.lowercase && checks.number;
        }

        function updateValidationUI(elementId, isValid) {
            const element = document.getElementById(elementId);
            const icon = element.querySelector('.validation-icon');

            if (isValid) {
                element.classList.remove('invalid');
                element.classList.add('valid');
                icon.textContent = '‚úì';
            } else {
                element.classList.remove('valid');
                element.classList.add('invalid');
                icon.textContent = '‚úó';
            }
        }

        // Real-time validation
        document.getElementById('newPassword').addEventListener('input', function (e) {
            validatePassword(e.target.value);
        });

        // Check if user is authenticated
        fetch('/api/account/me')
            .then(res => {
                if (!res.ok) {
                    window.location.href = 'login.html';
                } else {
                     // Check for auto-saved password
                    const tempPass = sessionStorage.getItem('temp_auto_pass');
                    if (tempPass) {
                        const oldPassInput = document.getElementById('oldPassword');
                        if (oldPassInput) {
                            oldPassInput.value = tempPass;
                            // Optional: sessionStorage.removeItem('temp_auto_pass'); // Keep it in case they refresh? No, better clear for security.
                            sessionStorage.removeItem('temp_auto_pass');
                        }
                    }
                }
            })
            .catch(() => {
                window.location.href = 'login.html';
            });

        document.getElementById('changePasswordForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const btn = this.querySelector('button[type="submit"]');

            // Reset messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorDiv.innerText = 'M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp';
                errorDiv.style.display = 'block';
                return;
            }

            // Validate password strength
            if (!validatePassword(newPassword)) {
                errorDiv.innerText = 'M·∫≠t kh·∫©u m·ªõi ch∆∞a ƒë√°p ·ª©ng ƒë·∫ßy ƒë·ªß y√™u c·∫ßu';
                errorDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.innerText = "ƒêang x·ª≠ l√Ω...";

            try {
                const response = await fetch('/api/account/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldPassword, newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    successDiv.innerText = data.message || 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!';
                    successDiv.style.display = 'block';

                    setTimeout(() => {
                        window.location.href = 'handbook.html';
                    }, 2000);
                } else {
                    errorDiv.innerText = data.message || 'ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i';
                    errorDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.innerText = 'ƒê·ªïi m·∫≠t kh·∫©u';
                }
            } catch (err) {
                errorDiv.innerText = 'L·ªói k·∫øt n·ªëi server';
                errorDiv.style.display = 'block';
                btn.disabled = false;
                btn.innerText = 'ƒê·ªïi m·∫≠t kh·∫©u';
            }
        });
    </script>
</body>

</html>